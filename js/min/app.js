!function(){"use strict";angular.module("ui-rangeSlider",[]).directive("rangeSlider",["$document","$filter","$log",function(a,b,c){var d=window.PointerEvent?1:window.MSPointerEvent?2:"ontouchend"in document?3:4,e=".rangeSlider",f={disabled:!1,orientation:"horizontal",step:0,decimalPlaces:0,showValues:!0,preventEqualMinMax:!1,attachHandleValues:!1},g=(1===d?"pointerdown":2===d?"MSPointerDown":3===d?"touchstart":"mousedown")+e,h=(1===d?"pointermove":2===d?"MSPointerMove":3===d?"touchmove":"mousemove")+e,i=(1===d?"pointerup":2===d?"MSPointerUp":3===d?"touchend":"mouseup")+e,j=function(a){try{return[a.clientX||a.originalEvent.clientX||a.originalEvent.touches[0].clientX,a.clientY||a.originalEvent.clientY||a.originalEvent.touches[0].clientY]}catch(b){return["x","y"]}},k=function(a){return 0>a?0:a>100?100:a},l=function(a){return!isNaN(parseFloat(a))&&isFinite(a)};return angular.element("html").addClass(4>d?"ngrs-touch":"ngrs-no-touch"),{restrict:"A",replace:!0,template:['<div class="ngrs-range-slider">','<div class="ngrs-runner">','<div class="ngrs-handle ngrs-handle-min"><i></i></div>','<div class="ngrs-handle ngrs-handle-max"><i></i></div>','<div class="ngrs-join"></div>',"</div>",'<div class="ngrs-value-runner">','<div class="ngrs-value ngrs-value-min" ng-show="showValues"><div>{{filteredModelMin}}</div></div>','<div class="ngrs-value ngrs-value-max" ng-show="showValues"><div>{{filteredModelMax}}</div></div>',"</div>","</div>"].join(""),scope:{disabled:"=?",min:"=",max:"=",modelMin:"=?",modelMax:"=?",onHandleDown:"&",onHandleUp:"&",orientation:"@",step:"@",decimalPlaces:"@",filter:"@",filterOptions:"@",showValues:"@",pinHandle:"@",preventEqualMinMax:"@",attachHandleValues:"@"},link:function(d,m,n){function o(a){"min"===a?(angular.element(w[0]).css("display","none"),angular.element(w[1]).css("display","block")):"max"===a?(angular.element(w[0]).css("display","block"),angular.element(w[1]).css("display","none")):(angular.element(w[0]).css("display","block"),angular.element(w[1]).css("display","block"))}function p(a){a?v.addClass("disabled"):v.removeClass("disabled")}function q(){d.min>d.max&&t("min must be less than or equal to max"),angular.isDefined(d.min)&&angular.isDefined(d.max)&&(l(d.min)||t("min must be a number"),l(d.max)||t("max must be a number"),D=d.max-d.min,C=[d.min,d.max],r())}function r(){if(d.modelMin>d.modelMax&&(u("modelMin must be less than or equal to modelMax"),d.modelMin=d.modelMax),(angular.isDefined(d.modelMin)||"min"===d.pinHandle)&&(angular.isDefined(d.modelMax)||"max"===d.pinHandle)){l(d.modelMin)||("min"!==d.pinHandle&&u("modelMin must be a number"),d.modelMin=d.min),l(d.modelMax)||("max"!==d.pinHandle&&u("modelMax must be a number"),d.modelMax=d.max);var a=k((d.modelMin-d.min)/D*100),c=k((d.modelMax-d.min)/D*100);if(d.attachHandleValues)var e=a,f=c;d.modelMin=Math.max(d.min,d.modelMin),d.modelMax=Math.min(d.max,d.modelMax),d.filter?(d.filteredModelMin=b(d.filter)(d.modelMin,d.filterOptions),d.filteredModelMax=b(d.filter)(d.modelMax,d.filterOptions)):(d.filteredModelMin=d.modelMin,d.filteredModelMax=d.modelMax),d.min===d.max&&d.modelMin==d.modelMax?(angular.element(w[0]).css(z,"0%"),angular.element(w[1]).css(z,"100%"),d.attachHandleValues&&(angular.element(".ngrs-value-runner").addClass("ngrs-attached-handles"),angular.element(x[0]).css(z,"0%"),angular.element(x[1]).css(z,"100%")),angular.element(y).css(z,"0%").css(A,"0%")):(angular.element(w[0]).css(z,a+"%"),angular.element(w[1]).css(z,c+"%"),d.attachHandleValues&&(angular.element(".ngrs-value-runner").addClass("ngrs-attached-handles"),angular.element(x[0]).css(z,e+"%"),angular.element(x[1]).css(z,f+"%"),angular.element(x[1]).css(A,"auto")),angular.element(y).css(z,a+"%").css(A,100-c+"%"),a>95&&angular.element(w[0]).css("z-index",3))}}function s(b){var c=w[b];c.bind(g+"X",function(f){var g=(0===b?"ngrs-handle-min":"ngrs-handle-max")+"-down",l=c.add(a).add("body"),m=(0===b?d.modelMin:d.modelMax)-d.min,n=m/D*100,o=j(f),p=o,q=!1;angular.isFunction(d.onHandleDown)&&d.onHandleDown(),angular.element("body").bind("selectstart"+e,function(){return!1}),d.disabled||(c.addClass("ngrs-down"),v.addClass("ngrs-focus "+g),angular.element("body").addClass("ngrs-touching"),a.bind(h,function(a){a.preventDefault();var e,f,g=j(a),h=d.step/D*100,i=((0===b?d.modelMax:d.modelMin)-d.min)/D*100;"x"!==g[0]&&(g[0]-=o[0],g[1]-=o[1],e=[p[0]!==g[0],p[1]!==g[1]],f=n+100*g[B]/(B?v.height():v.width()),f=k(f),d.preventEqualMinMax&&(0===h&&(h=1/D*100),0===b?i-=h:1===b&&(i+=h)),0===b?f=f>i?i:f:1===b&&(f=i>f?i:f),d.step>0&&100>f&&f>0&&(f=Math.round(f/h)*h),f>95&&0===b?c.css("z-index",3):c.css("z-index",""),e[B]&&f!=q&&(0===b?d.modelMin=parseFloat(f*D/100+d.min).toFixed(d.decimalPlaces):1===b&&(d.modelMax=parseFloat(f*D/100+d.min).toFixed(d.decimalPlaces)),d.$apply(),q=f),p=g)}).bind(i,function(){angular.isFunction(d.onHandleUp)&&d.onHandleUp(),l.off(e),angular.element("body").removeClass("ngrs-touching"),c.removeClass("ngrs-down"),v.removeClass("ngrs-focus "+g)}))})}function t(a){throw d.disabled=!0,new Error("RangeSlider: "+a)}function u(a){c.warn(a)}var v=angular.element(m),w=[m.find(".ngrs-handle-min"),m.find(".ngrs-handle-max")],x=[m.find(".ngrs-value-min"),m.find(".ngrs-value-max")],y=m.find(".ngrs-join"),z="left",A="right",B=0,C=[0,0],D=0;d.filteredModelMin=d.modelMin,d.filteredModelMax=d.modelMax,n.$observe("disabled",function(a){angular.isDefined(a)||(d.disabled=f.disabled),d.$watch("disabled",p)}),n.$observe("orientation",function(a){angular.isDefined(a)||(d.orientation=f.orientation);for(var b,c=d.orientation.split(" "),e=0,g=c.length;g>e;e++)c[e]="ngrs-"+c[e];b=c.join(" "),v.addClass(b),("vertical"===d.orientation||"vertical left"===d.orientation||"vertical right"===d.orientation)&&(z="top",A="bottom",B=1)}),n.$observe("step",function(a){angular.isDefined(a)||(d.step=f.step)}),n.$observe("decimalPlaces",function(a){angular.isDefined(a)||(d.decimalPlaces=f.decimalPlaces)}),n.$observe("showValues",function(a){d.showValues=angular.isDefined(a)?"false"===a?!1:!0:f.showValues}),n.$observe("pinHandle",function(a){d.pinHandle=angular.isDefined(a)&&("min"===a||"max"===a)?a:null,d.$watch("pinHandle",o)}),n.$observe("preventEqualMinMax",function(a){d.preventEqualMinMax=angular.isDefined(a)?"false"===a?!1:!0:f.preventEqualMinMax}),n.$observe("attachHandleValues",function(a){d.attachHandleValues=angular.isDefined(a)?"false"===a?!1:!0:f.attachHandleValues}),d.$watch("min",q),d.$watch("max",q),d.$watch("modelMin",r),d.$watch("modelMax",r),d.$on("$destroy",function(){v.off(e),angular.element("body").off(e),a.off(e);for(var b=0,c=w.length;c>b;b++)w[b].off(e),w[b].off(e+"X")}),v.bind("selectstart"+e,function(){return!1}).bind("click",function(a){a.stopPropagation()}),s(0),s(1)}}}]),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}()}(),function(a,b,c){function d(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)}function e(a){if("keypress"==a.type){var b=String.fromCharCode(a.which);return a.shiftKey||(b=b.toLowerCase()),b}return q[a.which]?q[a.which]:r[a.which]?r[a.which]:String.fromCharCode(a.which).toLowerCase()}function f(a){a=a||{};var b,c=!1;for(b in w)a[b]?c=!0:w[b]=0;c||(z=!1)}function g(a,b,c,d,e,f){var g,h,i=[],j=c.type;if(!u[a])return[];for("keyup"==j&&k(a)&&(b=[a]),g=0;g<u[a].length;++g)if(h=u[a][g],!(!d&&h.seq&&w[h.seq]!=h.level||j!=h.action||("keypress"!=j||c.metaKey||c.ctrlKey)&&b.sort().join(",")!==h.modifiers.sort().join(","))){var l=d&&h.seq==d&&h.level==f;(!d&&h.combo==e||l)&&u[a].splice(g,1),i.push(h)}return i}function h(a){var b=[];return a.shiftKey&&b.push("shift"),a.altKey&&b.push("alt"),a.ctrlKey&&b.push("ctrl"),a.metaKey&&b.push("meta"),b}function i(a,b,c,d){A.stopCallback(b,b.target||b.srcElement,c,d)||!1!==a(b,c)||(b.preventDefault?b.preventDefault():b.returnValue=!1,b.stopPropagation?b.stopPropagation():b.cancelBubble=!0)}function j(a){"number"!=typeof a.which&&(a.which=a.keyCode);var b=e(a);b&&("keyup"==a.type&&x===b?x=!1:A.handleKey(b,h(a),a))}function k(a){return"shift"==a||"ctrl"==a||"alt"==a||"meta"==a}function l(a,b,c,d){function g(b){return function(){z=b,++w[a],clearTimeout(p),p=setTimeout(f,1e3)}}function h(b){i(c,b,a),"keyup"!==d&&(x=e(b)),setTimeout(f,10)}for(var j=w[a]=0;j<b.length;++j){var k=j+1===b.length?h:g(d||m(b[j+1]).action);n(b[j],k,d,a,j)}}function m(a,b){var c,d,e,f=[];for(c="+"===a?["+"]:a.split("+"),e=0;e<c.length;++e)d=c[e],t[d]&&(d=t[d]),b&&"keypress"!=b&&s[d]&&(d=s[d],f.push("shift")),k(d)&&f.push(d);if(c=d,e=b,!e){if(!o){o={};for(var g in q)g>95&&112>g||q.hasOwnProperty(g)&&(o[q[g]]=g)}e=o[c]?"keydown":"keypress"}return"keypress"==e&&f.length&&(e="keydown"),{key:d,modifiers:f,action:e}}function n(a,b,c,d,e){v[a+":"+c]=b,a=a.replace(/\s+/g," ");var f=a.split(" ");1<f.length?l(a,f,b,c):(c=m(a,c),u[c.key]=u[c.key]||[],g(c.key,c.modifiers,{type:c.action},d,a,e),u[c.key][d?"unshift":"push"]({callback:b,modifiers:c.modifiers,action:c.action,seq:d,level:e,combo:a}))}var o,p,q={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},r={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},s={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},t={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},u={},v={},w={},x=!1,y=!1,z=!1;for(c=1;20>c;++c)q[111+c]="f"+c;for(c=0;9>=c;++c)q[c+96]=c;d(b,"keypress",j),d(b,"keydown",j),d(b,"keyup",j);var A={bind:function(a,b,c){a=a instanceof Array?a:[a];for(var d=0;d<a.length;++d)n(a[d],b,c);return this},unbind:function(a,b){return A.bind(a,function(){},b)},trigger:function(a,b){return v[a+":"+b]&&v[a+":"+b]({},a),this},reset:function(){return u={},v={},this},stopCallback:function(a,b){return-1<(" "+b.className+" ").indexOf(" mousetrap ")?!1:"INPUT"==b.tagName||"SELECT"==b.tagName||"TEXTAREA"==b.tagName||b.isContentEditable},handleKey:function(a,b,c){var d,e=g(a,b,c);b={};var h=0,j=!1;for(d=0;d<e.length;++d)e[d].seq&&(h=Math.max(h,e[d].level));for(d=0;d<e.length;++d)e[d].seq?e[d].level==h&&(j=!0,b[e[d].seq]=1,i(e[d].callback,c,e[d].combo,e[d].seq)):j||i(e[d].callback,c,e[d].combo);e="keypress"==c.type&&y,c.type!=z||k(a)||e||f(b),y=j&&"keydown"==c.type}};a.Mousetrap=A,"function"==typeof define&&define.amd&&define(A)}(window,document);var app=angular.module("speedReadingApp",["ui-rangeSlider"]);app.controller("MainCtrl",["$scope","$timeout","$interval","$window","$http",function(a,b,c,d,e){"use strict";a.settings={wpm:400,wpmMS:function(){return 6e4/a.settings.wpm},pauseBetweenParagraphs:!0,pauseBetweenSentences:!0,enableMultiplier:!0,nightMode:!1,text:"",highlightFocusPoint:!0,centerFocusPoint:!0,toastDefault:"",toast:"",useSerifFont:!0,pauseCountdown:1,countDownInProgress:!1,showLoadingOverlay:!1,init:!1},a.settings.toast=a.settings.toastDefault,a.game={words:[],currentWord:0,paused:!1,hasStarted:!1,percentComplete:function(b){var c=a.game.currentWord/a.game.words.length*100,d=b?c.toFixed(1):c;return d},timeToComplete:function(){var b=a.game.words.length-a.game.currentWord,c=b/a.settings.wpm,d=Math.round(c);return 1>c?"< 1":d}},a.modelsToAutoSave=["settings.wpm","settings.pauseBetweenSentences","enableMultiplier","settings.nightMode","settings.text","settings.highlightFocusPoint","settings.centerFocusPoint","settings.useSerifFont","game.words","game.currentWord","game.hasStarted"],Mousetrap.bind("space",function(){a.togglePause(),a.$apply()}),Mousetrap.bind(["left","a"],function(){a.pauseRead(),a.goToPosition("previous"),a.$apply()}),Mousetrap.bind(["right","d"],function(){a.pauseRead(),a.goToPosition("next"),a.$apply()}),Mousetrap.bind(["ctrl+left"],function(){a.pauseRead(),a.goToPosition("last_sentence"),a.$apply()}),a.$watch("settings.pauseBetweenSentences",function(){a.settings.pauseBetweenParagraphs=a.settings.pauseBetweenSentences}),angular.element("#timeline").on("mousedown",function(){a.pauseRead()}),a.settings.init=!0,window.settings=a.settings,a.autoSave={loadAll:function(){if(!localStorage.spread)return!1;var b=JSON.parse(localStorage.spread);for(var c in b){var d=b[c];"on"===d&&(d=!0),"off"===d&&(d=!1),d==parseInt(d)&&(d=parseInt(d)),c.split(".").reduce(function(a,b,c,e){return c===e.length-1&&(a[b]=d),a[b]},a)}},save:function(a,b){var c=localStorage.spread?JSON.parse(localStorage.spread):{};c[a]=b,localStorage.spread=JSON.stringify(c)},setup:function(){for(var b in a.modelsToAutoSave){var c=a.modelsToAutoSave[b];a.$watch(c,function(b){a.autoSave.save(this.exp,b)})}}},a.autoSave.loadAll(),a.autoSave.setup(),a.game.hasStarted&&(a.game.paused=!0),a.startRead=function(){if(a.game.hasStarted)return!1;if(a.isValidURL(a.settings.text))a.settings.showLoadingOverlay=!0,a.extractFromUrl(a.settings.text,function(c){if("success"===c.status){var d=c.result.betterTrim();a.settings.text=a.makeTextReadable(d),a.game.words=a.splitToWords(d),a.game.hasStarted=!0,a.game.paused=!1,a.resetToast(),b(function(){a.settings.showLoadingOverlay=!1,a.startCountdown(3*a.settings.pauseCountdown)},300)}else a.settings.showLoadingOverlay=!1,a.flashToast("Error: Could not parse URL")});else{if(a.game.words=a.splitToWords(a.settings.text),a.game.words.length<2)return a.flashToast("Please enter something to read"),!1;a.game.hasStarted=!0,a.game.paused=!1,b(function(){a.startCountdown(3*a.settings.pauseCountdown)},300)}},a.startCountdown=function(d){if(a.settings.countDownInProgress)return!1;a.settings.countDownInProgress=!0;var e=angular.element("#countdown-bar"),f=e.find(".progress"),g=1,h=100/d;e.addClass("visible"),b(function(){f.css("width",h+"%"),a.countDownTimeout=c(function(){var b=h*(g+1);return f.css("width",b+"%"),g>=d?(a.wordLoop(),c.cancel(a.countDownTimeout),e.removeClass("visible"),f.attr("style",""),a.settings.countDownInProgress=!1,!1):void(g+=1)},1e3)},50)},a.stopRead=function(){return a.game.hasStarted?(a.game.hasStarted=!1,a.game.paused=!1,void(a.game.currentWord=0)):!1},a.restartRead=function(){a.pauseRead(),a.game.currentWord=0,a.continueRead()},a.pauseRead=function(){return!a.game.hasStarted||a.game.paused?!1:(angular.element("#countdown-bar").removeClass("visible"),void(a.game.paused=!0))},a.continueRead=function(b){return a.game.hasStarted&&a.game.paused?(b&&a.goToPosition(b),a.game.paused=!1,a.game.hasStarted=!0,void a.startCountdown(a.settings.pauseCountdown)):!1},a.goToPosition=function(b){if("last_sentence"===b)var c=a.findLastSentence();else if("previous"===b){if(a.game.currentWord>0)var c=a.game.currentWord-1}else if("next"===b&&a.game.currentWord<a.game.words.length)var c=a.game.currentWord+1;isNaN(c)||(a.game.currentWord=c)},a.togglePause=function(){return a.game.hasStarted?void(a.game.paused?a.continueRead():a.pauseRead()):!1},a.extractFromUrl=function(a,b){a=a.betterTrim(),e.get(window.base_url+"readability.php?url="+encodeURIComponent(a)).success(function(a){b(a)}).error(function(){b(!1)})},a.flashToast=function(c){a.settings.toast=c,b(a.resetToast,3e3)},a.resetToast=function(){a.settings.toast=a.settings.toastDefault},a.findLastSentence=function(){for(var b=a.game.currentWord,b=b>0?b-1:b,c=b;c>=2;--c){var d=a.game.words[c].value,e=a.game.words[c-1].value,f=a.game.words[c-2].value;if(a.isBeginningOfSentence(d)&&(a.isEndOfSentence(e)||a.isEndOfSentence(f)))return c}return 0},a.isBeginningOfSentence=function(a){return a=a.betterTrim().replace(/\s/,""),""===a?!1:a.charAt(0)===a.charAt(0).toUpperCase()?!0:!1},a.isEndOfSentence=function(a){var b=a.slice(-1);return"!"===b||"?"===b||"."===b?!0:!1},a.splitToWords=function(b){var b=b.betterTrim().replace(/(\s){2,}/g,"$1"),c=b.split(/[\n]/),d=[];if(b.length<1)return[];for(var e in c){var f=c[e],g=f.split(" "),h=!1;for(var i in g){var j,k=g[i],l=k.slice(-1);j=k.length<=4?.7:k.length<=8?1:k.length<=12?1.3:1.5;var m=a.highlightFocusPoint(k);d.push({type:"word",multiplier:j,value:k,raw:m}),h=!1,("."===l||"?"===l||"!"===l)&&(d.push({type:"pause",multiplier:1.5,value:"",raw:{specialChar:"(new line)"}}),h=!0)}h||d.push({type:"pause",multiplier:1.5,value:"",raw:{specialChar:"(new paragraph)"}})}return a.settings.pauseBetweenParagraphs&&d.pop(),d},a.highlightFocusPoint=function(a){var b=.33,c=a.length,d=Math.floor(c*b),e={start:a.slice(0,d),highlighted:a.slice(d,d+1),end:a.slice(d+1)};return e},a.wordLoop=function(){if(a.game.hasStarted===!1||a.game.paused===!0)return!1;var c=a.game.words[a.game.currentWord];if(!a.settings.pauseBetweenSentences&&"pause"==c.type)return a.game.currentWord+=1,void a.wordLoop();if(a.game.currentWord<a.game.words.length-1){var d=a.settings.wpmMS(),e=c.multiplier,f=d;if(a.settings.enableMultiplier)var f=d*e;b.cancel(a.wordLoopTimeout),a.wordLoopTimeout=b(function(){a.game.hasStarted===!0&&a.game.paused===!1&&(a.game.currentWord+=1,a.wordLoop())},f)}else b(function(){a.stopRead()},500)},a.makeTextReadable=function(a){return a.betterTrim().replace(/(\r\n|\n|\r)+/gm,"\r\n\r\n")},a.isValidURL=function(a){return a.betterTrim().match(/^\bhttps?:\/\/?[-A-Za-z0-9+&@#\/%?=~_|!:,.;]+[-A-Za-z0-9+&@#\/%=~_|]$/)}}]),app.filter("unsafe",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]),app.directive("toggleDropdown",["$timeout",function(a){return{link:function(b,c,d){var e=function(a){console.log(angular.element(a.target).closest(".dropdown").length,a.target),!angular.element(a.target).closest(".dropdown").length>0&&(angular.element(".dropdown").removeClass("open"),angular.element(document).off("click.closeDropdown"))};angular.element(c[0]).on("click",function(b){var c=angular.element(document.getElementById(d.toggleDropdown)),f=angular.element(".dropdown.open");return f.length?(e(b),!1):void(c.length>0&&!c.is(".open")&&(c.addClass("open"),a(function(){angular.element(document).on("click.closeDropdown",e)},0)))})}}}]),String.prototype.betterTrim=function(){return this.replace(/\s+(?=\s)/g,"").trim()};